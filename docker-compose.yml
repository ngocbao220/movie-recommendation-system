services:
  # 1. Pre-PROCESS: Chạy 1 lần rồi tắt (Ephemeral Container)
  preprocess-data:
    container_name: preprocess
    build: .
    volumes:
      - ./:/app
    # Chỉ chạy script xử lý data rồi tự thoát
    command: >
      bash -c "
      echo '⏳ Đang xử lý dữ liệu...' &&
      python src/data/preprocess.py &&
      echo '✅ Processing hoàn tất!'
      "
    # Restart: no -> Để docker không cố khởi động lại nó sau khi nó đã làm xong việc
    restart: "no"

  # 2. Training
  models-training:
    container_name: models-training
    build: .
    volumes:
      - ./:/app
    command: >
      bash -c "
      echo '⏳ Train Model 1 (Rules)...' &&
      python models/model_1_rules/train.py &&
      echo '✅ Model 1 xong!' &&
      
      echo '⏳ Train Model 2 (ALS)...' &&
      python models/model_2_als/train.py &&
      echo '✅ Model 2 xong!'
      "
    depends_on:
      preprocess-data:
        condition: service_completed_successfully
      
# echo '⏳ Train Model Rules...' &&
# python models/model_1_rules/train.py &&
# echo '✅ Rules xong!'
    

  # 4. APP: Web API
  api:
    container_name: web-api
    build: .
  # Backend: FastAPI serving ML models
  backend:
    container_name: movie-backend
    build:
      context: .
      dockerfile: Dockerfile.backend
    ports:
      - "8001:8001"
    volumes:
      - ./src:/app/src
      - ./models:/app/models
      - ./data:/app/data
      - ./checkpoints:/app/checkpoints
      - ./setting:/app/setting
    environment:
      - PYTHONUNBUFFERED=1
      - TMDB_API_KEY=ff48b02cdcd1f6e40df93cb3ff292031
    command: python src/ui/api.py
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/movies/popular"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - movie-network

  # Frontend: React + Vite
  frontend:
    container_name: movie-frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
    environment:
      - VITE_API_URL=http://localhost:8001
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - movie-network

networks:
  movie-network:
    driver: bridge