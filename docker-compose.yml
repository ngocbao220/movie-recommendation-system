services:
  # 1. Pre-processing Data
  preprocess-data:
    container_name: preprocess-data
    build: .
    volumes:
      - ./:/app
    # Chỉ chạy script xử lý data rồi tự thoát
    command: >
      bash -c "
      echo '⏳ Đang xử lý dữ liệu...' &&
      python src/data/preprocess.py &&
      echo '✅ Processing hoàn tất!'
      "

  # 2. Training Models
  models-training:
    container_name: models-training
    build: .
    volumes:
      - ./:/app
    command: >
      bash -c "
      echo '⏳ Train Model 1 (Rules)...' &&
      python models/model_1_rules/train.py &&
      echo '✅ Model 1 xong!' &&
      
      echo '⏳ Train Model 2 (ALS)...' &&
      python models/model_2_als/train.py &&
      echo '✅ Model 2 xong!'
      "
    depends_on:
      preprocess-data:
        condition: service_completed_successfully

  # 4. APP: Web API
  api:
    container_name: web-api
    build:
      context: .
    ports:
      - "8000:8000"
    volumes:
      - ./:/app
    environment:
      - PYTHONUNBUFFERED=1
    command: python src/api/main.py

  # Frontend: React + Vite
  frontend:
    container_name: frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
    environment:
      - VITE_API_URL=http://localhost:8001
    depends_on:
      - api
    networks:
      - movie-network

networks:
  movie-network:
    driver: bridge